- name: Prepare
  hosts: all
  become: yes
  gather_facts: false

  vars_files:
    - ../../vars.yml

  tasks:
    - name: Install Ansible dependencies
      yum:
        update_cache: yes
        name: "{{ prepare_yum_packages }}"
        state: present

    - name: Create groups
      group:
        name: '{{ item }}'
        state: present
      loop:
        - adm
        - wheel
        - ec2-user
        - ssm-user

    - name: Create AWS users
      user:
        name: '{{ item }}'
        password: "{{ item | password_hash('sha512', 'ansiblesalt') }}"
        groups:
          - adm
          - wheel
          - '{{ item }}'
        create_home: yes
        shell: /bin/bash
        state: present
      loop:
        - ec2-user
        - ssm-user
